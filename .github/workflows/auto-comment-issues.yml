name: Auto Comment on New Issues

on:
  schedule:
    # 1時間毎に実行 (UTC時間)
    - cron: '0 */1 * * *'
  workflow_dispatch: # 手動実行も可能

jobs:
  comment-on-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new issues and comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            console.log(`Checking all open issues for Claude responses...`);

            // すべてのopenなissueを取得
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 100
            });

            let commentedCount = 0;
            const maxCommentsPerRun = 1; // 1回の実行で1つだけコメント

            for (const issue of issues.data) {
              // 既に上限に達した場合は終了
              if (commentedCount >= maxCommentsPerRun) {
                console.log(`Reached maximum comments per run (${maxCommentsPerRun}), stopping.`);
                break;
              }

              // Pull Requestは除外
              if (issue.pull_request) continue;

              // このissueに紐づくPull Requestがあるかチェック
              const linkedPRs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100
              });

              const hasLinkedPR = linkedPRs.data.some(pr => {
                // PRの本文やタイトルにissue番号が含まれているかチェック
                const prBody = pr.body || '';
                const prTitle = pr.title || '';
                const issueRef = `#${issue.number}`;
                const issueRefLong = `${context.repo.owner}/${context.repo.repo}#${issue.number}`;
                return prBody.includes(issueRef) || prBody.includes(issueRefLong) ||
                       prTitle.includes(issueRef) || prTitle.includes(issueRefLong);
              });

              if (hasLinkedPR) {
                console.log(`Issue #${issue.number} has linked PR, skipping.`);
                continue;
              }

              // 既にコメントされているかチェック
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });

              const alreadyCommented = comments.data.some(comment =>
                comment.body.includes('@claude 実装して')
              );

              // Claudeからのコメント（反応）があるかチェック
              const hasClaudeResponse = comments.data.some(comment => {
                // Claude botのユーザー名で明示的にチェック（github-actions[bot]は除外）
                const isClaudeBot = comment.user.login === 'claude' ||
                                   comment.user.login === 'claude[bot]' ||
                                   comment.user.login === 'claude-ai[bot]' ||
                                   comment.user.login === 'anthropics-claude[bot]';
                return isClaudeBot;
              });

              if (alreadyCommented && hasClaudeResponse) {
                console.log(`Issue #${issue.number} already has Claude response, skipping.`);
                continue;
              }

              if (!alreadyCommented || !hasClaudeResponse) {
                // コメントを投稿（まだコメントしていない、またはClaudeの反応がない場合）
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '@claude pluginで使える形で実装して。実装が終わったら`gh pr create`コマンドを使ってPullRequestをmainブランチに対して自動作成して。手動リンクは不要です。'
                });

                console.log(`Commented on issue #${issue.number}: ${issue.title}`);
                commentedCount++;
              }
            }

            console.log(`Total issues commented: ${commentedCount}`);
