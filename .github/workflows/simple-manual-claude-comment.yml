name: Simple Manual Claude Comment

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issueç•ªå· (ç©ºæ¬„ã®å ´åˆã¯å…¨ã¦ã®open issueã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º)'
        required: false
        type: string
      comment_message:
        description: 'ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¡ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)'
        required: false
        type: string

jobs:
  process-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List issues or comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const issueNumberInput = '${{ github.event.inputs.issue_number }}';
            const customMessage = '${{ github.event.inputs.comment_message }}';
            const defaultMessage = '@claude pluginã§ä½¿ãˆã‚‹å½¢ã§å®Ÿè£…ã—ã¦ã€‚å®Ÿè£…ãŒçµ‚ã‚ã£ãŸã‚‰`gh pr create`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦PullRequestã‚’mainãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã—ã¦è‡ªå‹•ä½œæˆã—ã¦ã€‚æ‰‹å‹•ãƒªãƒ³ã‚¯ã¯ä¸è¦ã§ã™ã€‚';
            const commentMessage = customMessage || defaultMessage;

            if (!issueNumberInput || issueNumberInput.trim() === '') {
              // Issueç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒªã‚¹ãƒˆè¡¨ç¤º
              console.log('ğŸ“‹ Open Issues ãƒªã‚¹ãƒˆ\n');

              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'created',
                direction: 'desc',
                per_page: 100
              });

              const issueList = issues.data
                .filter(issue => !issue.pull_request)
                .map(issue => {
                  const labels = issue.labels.map(l => l.name).join(', ');
                  return {
                    number: issue.number,
                    title: issue.title,
                    labels: labels,
                    url: issue.html_url
                  };
                });

              if (issueList.length === 0) {
                console.log('âŒ Open issueãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
              } else {
                console.log(`âœ… å…¨ ${issueList.length} ä»¶ã®open issues:\n`);
                console.log('ç•ªå· | ã‚¿ã‚¤ãƒˆãƒ« | ãƒ©ãƒ™ãƒ«');
                console.log('-----|----------|--------');
                issueList.forEach(item => {
                  console.log(`#${item.number} | ${item.title} | ${item.labels || 'ãªã—'}`);
                });

                console.log('\n\nğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:');
                console.log('1. ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†åº¦å®Ÿè¡Œ');
                console.log('2. "Issueç•ªå·" ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸã„issueç•ªå·ã‚’å…¥åŠ›');
                console.log('   ä¾‹: 46');
                console.log('3. å¿…è¦ã«å¿œã˜ã¦ "ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¡ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" ã‚’å…¥åŠ›');
                console.log('4. "Run workflow" ã‚’ã‚¯ãƒªãƒƒã‚¯');
              }
            } else {
              // Issueç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆ
              const issueNumber = parseInt(issueNumberInput.trim());

              if (isNaN(issueNumber)) {
                core.setFailed(`ç„¡åŠ¹ãªissueç•ªå·: ${issueNumberInput}`);
                return;
              }

              console.log(`ğŸ“ Issue #${issueNumber} ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã™...`);

              try {
                // Issueã®å–å¾—
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });

                // Pull Requestã¯é™¤å¤–
                if (issue.data.pull_request) {
                  console.log(`âŒ Issue #${issueNumber} ã¯Pull Requestã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
                  return;
                }

                console.log(`âœ… Issue #${issueNumber}: ${issue.data.title}`);

                // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });

                const alreadyCommented = comments.data.some(comment =>
                  comment.body.includes('@claude')
                );

                if (alreadyCommented) {
                  console.log(`âš ï¸  Issue #${issueNumber} ã«ã¯æ—¢ã«Claudeã‚³ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™ã€‚`);
                  console.log(`ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (å¼·åˆ¶çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™)`);
                }

                // ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: commentMessage
                });

                console.log(`âœ… Issue #${issueNumber} ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸï¼`);
                console.log(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${commentMessage}`);
                console.log(`URL: ${issue.data.html_url}`);

              } catch (error) {
                core.setFailed(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
              }
            }
